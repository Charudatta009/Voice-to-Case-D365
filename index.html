<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voice to Case - D365 Enhanced</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px; }
    #status { margin-top: 20px; font-size: 16px; }
    #transcript { margin-top: 10px; font-size: 18px; color: #444; white-space: pre-line; }
  </style>
</head>
<body>

  <h2>üé§ Voice-to-Case Generator (D365) - Enhanced</h2>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <p id="status">Status: Idle</p>
  <div id="transcript"></div>

  <script>
    let recognition;
    let isRecording = false;
    let transcriptText = '';

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const transcriptDiv = document.getElementById("transcript");

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SpeechRecognition();
      recog.lang = 'en-US';
      recog.continuous = true;
      recog.interimResults = false;

      recog.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            transcriptText += event.results[i][0].transcript + '\n';
          }
        }
        transcriptDiv.innerText = `You said:\n${transcriptText}`;
      };

      recog.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        status.innerText = `Error: ${event.error}`;
      };

      recog.onend = () => {
        if (isRecording) {
          console.log("Recognition ended. Restarting...");
          recog.start(); // Restart automatically if still recording
        }
      };

      return recog;
    }

    startBtn.onclick = () => {
      transcriptText = '';
      transcriptDiv.innerText = "";
      status.innerText = "Status: Listening...";
      startBtn.disabled = true;
      stopBtn.disabled = false;
      isRecording = true;

      recognition = initRecognition();
      recognition.start();
    };

    stopBtn.onclick = () => {
      isRecording = false;
      recognition.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      status.innerText = "Status: Processing...";
      transcriptDiv.innerText = `You said:\n${transcriptText}`;
      sendToBackend(transcriptText);
    };

    async function sendToBackend(text) {
      try {
        const response = await fetch("https://voice-to-case-d365.onrender.com/transcribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ transcript: text })
        });

        const result = await response.json();
         console.log("Backend response:", result);

        if (response.ok) {
          status.innerText = `‚úÖ Case created! Sentiment: ${result.sentiment}, Priority: ${result.priority}`;
          console.log(result); // ‚Üê Add this line

        } else {
          status.innerText = `‚ùå Failed: ${result.error}`;
        }
      } catch (error) {
        status.innerText = `‚ùå Error: ${error.message}`;
      }
    }
  </script>
</body>
</html>
